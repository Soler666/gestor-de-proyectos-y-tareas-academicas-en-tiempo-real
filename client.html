<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente Socket.io</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            position: relative;
        }
        .container {
            display: flex;
            gap: 40px;
        }
        .login-section, .socket-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .chat-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 2;
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .message strong {
            color: #007bff;
        }
        .message small {
            color: #666;
            font-size: 0.8em;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input, select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .task-list, .project-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item, .project-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #fafafa;
        }
        .task-submit-btn, .project-submit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .task-submit-btn:hover, .project-submit-btn:hover {
            background: #218838;
        }
        .task-item h4, .project-item h4 {
            margin: 0 0 10px 0;
        }
        .task-item p, .project-item p {
            margin: 5px 0;
        }
        .tasks-section, .projects-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            max-width: 600px;
        }
        .nav {
            text-align: center;
            margin: 20px 0;
        }
        .nav button {
            margin: 0 10px;
        }
        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .admin-users-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .admin-user-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-user-info {
            flex: 1;
        }
        .admin-user-actions {
            display: flex;
            gap: 5px;
        }
        .admin-user-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .pending-users {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .approved-users {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .rejected-users {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .exam-section, .exams-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .exam-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .exam-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .exam-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #fafafa;
        }
        .exam-timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
            margin: 20px 0;
        }
        .exam-question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .exam-options {
            margin-top: 10px;
        }
        .exam-option {
            display: block;
            margin: 5px 0;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .exam-results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .exam-taking {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 20px auto;
        }
        .exam-question-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .exam-question-number {
            font-weight: bold;
        }
        .exam-submit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .exam-submit-btn:hover {
            background: #218838;
        }
        .exam-submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .exam-section, .exams-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .exam-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .exam-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .exam-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #fafafa;
        }
        .exam-timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
            margin: 20px 0;
        }
        .exam-question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .exam-options {
            margin-top: 10px;
        }
        .exam-option {
            display: block;
            margin: 5px 0;
        }
        .exam-results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .submission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .submission-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .file-drop-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: border-color 0.3s;
        }
        .file-drop-area.dragover {
            border-color: #0056b3;
            background: #f0f8ff;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .remove-file {
            color: red;
            cursor: pointer;
            font-weight: bold;
        }
        .submission-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .submission-status.submitted {
            background: #d4edda;
            color: #155724;
        }
        .submission-status.graded {
            background: #d1ecf1;
            color: #0c5460;
        }
        .submission-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .submission-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        .grade-form {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .grade-input {
            width: 80px;
            padding: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .google-login-btn {
            background: #ffffff;
            color: #757575;
            border: 1px solid #dadce0;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .google-login-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        }
        .google-login-btn:active {
            background: #f1f3f4;
        }
        .google-login-btn img {
            width: 18px;
            height: 18px;
        }
        .login-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #dadce0;
            z-index: 0;
        }
        .divider span {
            background: white;
            padding: 0 15px;
            color: #5f6368;
            position: relative;
            z-index: 1;
            font-size: 12px;
            text-transform: uppercase;
        }
        .submissions-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .submission-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .submission-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .submission-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #fafafa;
        }
        .file-input {
            margin-top: 10px;
        }
        .reports-section, .reminders-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .report-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .reminder-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .reminder-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #fafafa;
        }
        .view {
            display: none;
        }
        #chat-view {
            display: block;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            z-index: 1001;
        }
        .notification-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }
        .notification-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .notification-item.unread {
            background: #f0f8ff;
        }
        .notification-item:hover {
            background: #f9f9f9;
        }
        .chat-tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .chat-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .chat-tab.active {
            background: #007bff;
            color: white;
        }
        .chat-tab-content {
            display: none;
        }
        .notifications-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .notification-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .notification-form h3 {
            margin-top: 0;
            color: #007bff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .preference-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .preference-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .bulk-users-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .user-checkbox {
            display: block;
            margin-bottom: 5px;
        }
        .submission-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        .submission-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .submission-form h3 {
            margin-top: 0;
            color: #007bff;
        }
        .submission-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .submission-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #fafafa;
        }
        .submission-item h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .submission-item p {
            margin: 5px 0;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }

        .submission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .submission-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .file-drop-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: border-color 0.3s;
        }
        .file-drop-area.dragover {
            border-color: #0056b3;
            background: #f0f8ff;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .remove-file {
            color: red;
            cursor: pointer;
            font-weight: bold;
        }
        .submission-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .submission-status.submitted {
            background: #d4edda;
            color: #155724;
        }
        .submission-status.graded {
            background: #d1ecf1;
            color: #0c5460;
        }
        .submission-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .grade-form {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .grade-input {
            width: 80px;
            padding: 5px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Plataforma de Gestión Académica</h1>

    <div id="login-section">
        <div class="container">
            <div class="login-section">
                <h2>Login</h2>
                <label for="username">Usuario:</label>
                <input type="text" id="username" placeholder="Usuario">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" placeholder="Contraseña">
                <button id="login">Iniciar Sesión</button>

                <div class="divider">
                    <span>O</span>
                </div>

                <button id="google-login" class="google-login-btn" onclick="window.location.href='http://localhost:8000/auth/google'">
                    <img src="https://www.google.com/favicon.ico" alt="Google Logo">
                    Iniciar sesión con Google
                </button>

                <label for="token">Token JWT:</label>
                <input type="text" id="token" placeholder="Ingresa tu token JWT">
                <button id="connect">Conectar Socket</button>
            </div>
            <div class="login-section">
                <h2>Registro</h2>
                <label for="reg-username">Usuario:</label>
                <input type="text" id="reg-username" placeholder="Usuario">
                <label for="reg-password">Contraseña:</label>
                <input type="password" id="reg-password" placeholder="Contraseña">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" placeholder="email@ejemplo.com">
                <label for="reg-firstname">Nombre:</label>
                <input type="text" id="reg-firstname" placeholder="Tu nombre">
                <label for="reg-lastname">Apellido:</label>
                <input type="text" id="reg-lastname" placeholder="Tu apellido">
                <label for="reg-role">Rol:</label>
                <select id="reg-role">
                    <option value="ALUMNO">Alumno</option>
                    <option value="TUTOR">Tutor</option>
                </select>
                <button id="register">Registrarse</button>

                <div class="divider">
                    <span>O</span>
                </div>

                <button id="google-register" class="google-login-btn" onclick="window.location.href='http://localhost:8000/auth/google'">
                    <img src="https://www.google.com/favicon.ico" alt="Google Logo">
                    Registrarse con Google
                </button>
            </div>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div id="notification-bell" class="notification-bell">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C10.896 2 10 2.896 10 4V5.586L7.707 8.293C7.512 8.488 7.256 8.744 7.061 9.061L4.707 11.414C4.512 11.609 4.256 11.865 4.061 12.182L2 14.243V16H22V14.243L19.939 12.182C19.744 11.987 19.488 11.731 19.293 11.414L16.939 9.061C16.744 8.766 16.488 8.51 16.293 8.293L14 5.586V4C14 2.896 13.104 2 12 2ZM12 4C12.552 4 13 4.448 13 5V6H11V5C11 4.448 11.448 4 12 4ZM10.414 8H13.586L15.586 10H8.414L10.414 8ZM6.414 12H17.586L19 13.757V14H5V13.757L6.414 12Z" fill="#007bff"/>
                <path d="M12 22C13.1046 22 14 21.1046 14 20H10C10 21.1046 10.8954 22 12 22Z" fill="#007bff"/>
            </svg>
            <span id="notification-count" class="notification-count">0</span>
        </div>
        <div id="notification-dropdown" class="notification-dropdown">
            <ul id="notification-list"></ul>
        </div>

        <div id="user-info-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div id="user-info" style="font-weight: bold; color: #007bff; font-size: 16px;">
                Bienvenido: <span id="user-name"></span> (<span id="user-role"></span>)
            </div>
            <div id="nav-section" class="nav">
                <button id="show-chat">Chat Público</button>
                <button id="show-tasks">Tareas</button>
                <button id="show-projects">Proyectos</button>
                <button id="show-reports">Reportes</button>
                <button id="show-reminders">Recordatorios</button>
            <button id="show-exams">Exámenes</button>
            <button id="show-chatbot">Chatbot Educativo</button>
            <button id="show-admin" style="display: none;">Administrar Usuarios</button>
            <button id="logout">Cerrar Sesión</button>
            </div>
        </div>

        <div id="chat-view" class="view">
        <div class="container">
            <div class="chat-section">
                <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                    <h2 id="public-tab" style="cursor: pointer; color: #007bff; border-bottom: 2px solid #007bff; margin: 0; padding-bottom: 5px;">Chat Público</h2>
                    <h2 id="private-tab" style="cursor: pointer; color: #555; margin: 0;" class="private-tab-inactive">Chat Privado</h2>
                </div>

                <div id="public-chat-content">
                    <div id="messages" class="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="message" placeholder="Escribe un mensaje público">
                        <button id="send">Enviar</button>
                    </div>
                </div>

                <div id="private-chat-content" style="display: none;">
                    <div id="private-recipient-selector" style="margin-bottom: 10px;">
                        <label for="private-recipient">Seleccionar destinatario:</label>
                        <select id="private-recipient">
                            <option value="">Selecciona un destinatario</option>
                        </select>
                    </div>
                    <div id="private-messages" class="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="private-message" placeholder="Escribe un mensaje privado">
                        <button id="send-private">Enviar Privado</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tasks-view" class="view" style="display: none;">
        <div class="container">
            <div class="tasks-section">
                <h2>Tareas</h2>
                <div id="tasks" class="task-list"></div>
                <div id="create-task" style="display: none;">
                    <h3 id="task-form-title">Crear Tarea</h3>
                    <form id="task-form" style="display: flex; flex-wrap: wrap; gap: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-type">Tipo de tarea:</label>
                            <select id="task-type">
                                <option value="daily">Diaria</option>
                                <option value="project">Proyecto</option>
                            </select>
                        </div>
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-name">Nombre:</label>
                            <input type="text" id="task-name" placeholder="Nombre de la tarea" required>
                        </div>
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-description">Descripción:</label>
                            <textarea id="task-description" placeholder="Descripción"></textarea>
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-responsible">Asignar a alumno:</label>
                            <select id="task-responsible" required>
                                <option value="">Cargando...</option>
                                <!-- Opciones cargadas dinámicamente -->
                            </select>
                        </div>
                        <div id="project-field" style="flex: 1 1 200px; display: none; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-project">Proyecto:</label>
                            <select id="task-project">
                                <option value="">Sin proyecto</option>
                                <!-- Opciones de proyectos para tareas de proyecto -->
                            </select>
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-due-date">Fecha límite:</label>
                            <input type="datetime-local" id="task-due-date">
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-priority">Prioridad:</label>
                            <select id="task-priority">
                                <option value="Baja">Baja</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="task-status">Estado:</label>
                            <select id="task-status">
                                <option value="Pendiente">Pendiente</option>
                                <option value="En progreso">En progreso</option>
                                <option value="Completada">Completada</option>
                                <option value="Bloqueada">Bloqueada</option>
                            </select>
                        </div>
                        <div style="flex-basis: 100%; display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" id="save-task">Guardar</button>
                            <button type="button" id="cancel-task">Cancelar</button>
                        </div>
                    </form>
                </div>
                <button id="new-task-btn" style="display: none;">Nueva Tarea</button>
            </div>
        </div>
    </div>

    <div id="projects-view" class="view" style="display: none;">
        <div class="container">
            <div class="projects-section">
                <h2>Proyectos</h2>
                <div id="projects" class="project-list"></div>
                <div id="create-project" style="display: none;">
                    <h3 id="project-form-title">Crear Proyecto</h3>
                    <form id="project-form" style="display: flex; flex-wrap: wrap; gap: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-name">Nombre del proyecto:</label>
                            <input type="text" id="project-name" placeholder="Nombre del proyecto">
                        </div>
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-description">Descripción:</label>
                            <textarea id="project-description" placeholder="Descripción"></textarea>
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-start-date">Fecha de inicio:</label>
                            <input type="datetime-local" id="project-start-date">
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-end-date">Fecha de fin:</label>
                            <input type="datetime-local" id="project-end-date">
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-status">Estado:</label>
                            <select id="project-status">
                                <option value="Planificación">Planificación</option>
                                <option value="En progreso">En progreso</option>
                                <option value="Completado">Completado</option>
                                <option value="Pausado">Pausado</option>
                            </select>
                        </div>
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="project-participants">Asignar a alumno:</label>
                            <select id="project-participants" style="max-height: 40px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
                                <!-- Opciones cargadas dinámicamente -->
                            </select>
                        </div>
                        <div style="flex-basis: 100%; display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" id="save-project">Guardar</button>
                            <button type="button" id="cancel-project">Cancelar</button>
                        </div>
                    </form>
                </div>
                <button id="new-project-btn" style="display: none;">Nuevo Proyecto</button>
            </div>
        </div>
    </div>

    <div id="reports-view" class="view" style="display: none;">
        <div class="container">
            <div class="reports-section">
                <h2>Reportes</h2>
            <button id="load-student-progress">Progreso de Alumnos</button>
            <button id="load-tutor-performance">Rendimiento de Tutores</button>
            <button id="load-project-stats">Estadísticas de Proyectos</button>
            <button id="load-dashboard-metrics">Métricas del Dashboard</button>
            <button id="load-activity-history">Historial de Actividades</button>
            <button id="load-welcome">Welcome</button>
                <div id="reports-content"></div>
            </div>
        </div>
    </div>

    <div id="reminders-view" class="view" style="display: none;">
        <div class="container">
            <div class="reminders-section">
                <h2>Recordatorios</h2>
                <div id="create-reminder" style="display: none;">
                    <h3 id="reminder-form-title">Crear Recordatorio</h3>
                    <form id="reminder-form" style="display: flex; flex-wrap: wrap; gap: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="reminder-title">Título:</label>
                            <input type="text" id="reminder-title" placeholder="Título del recordatorio" required>
                        </div>
                        <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="reminder-description">Descripción:</label>
                            <textarea id="reminder-description" placeholder="Descripción"></textarea>
                        </div>
                        <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                            <label for="reminder-date">Fecha y hora:</label>
                            <input type="datetime-local" id="reminder-date" required>
                        </div>
                        <div style="flex-basis: 100%; display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit">Guardar</button>
                            <button type="button" id="cancel-reminder">Cancelar</button>
                        </div>
                    </form>
                </div>
            <button id="new-reminder-btn">Nuevo Recordatorio</button>
            <div id="reminders" class="reminder-list"></div>
        </div>
    </div>
</div>

    <div id="exams-view" class="view" style="display: none;">
    <div class="container">
        <div class="exams-section">
            <h2>Exámenes</h2>
            <div id="exams" class="exam-list"></div>
            <div id="create-exam" style="display: none;">
                <h3 id="exam-form-title">Crear Examen</h3>
                <form id="exam-form" style="display: flex; flex-wrap: wrap; gap: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                        <label for="exam-title">Título del examen:</label>
                        <input type="text" id="exam-title" placeholder="Título del examen" required>
                    </div>
                    <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                        <label for="exam-topics">Temas (separados por coma):</label>
                        <input type="text" id="exam-topics" placeholder="Matemáticas, Física, Química" required>
                    </div>
                    <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                        <label for="exam-num-questions">Número de preguntas:</label>
                        <input type="number" id="exam-num-questions" placeholder="10" min="1" max="50" required>
                    </div>
                    <div style="flex: 1 1 200px; display: flex; flex-direction: column; margin-bottom: 15px;">
                        <label for="exam-time-limit">Tiempo límite (minutos):</label>
                        <input type="number" id="exam-time-limit" placeholder="60" min="5" max="300" required>
                    </div>
                    <div style="flex: 1 1 300px; display: flex; flex-direction: column; margin-bottom: 15px;">
                        <label for="exam-assigned-to">Asignar a estudiantes:</label>
                        <select id="exam-assigned-to" multiple style="min-height: 100px;" required>
                            <!-- Opciones cargadas dinámicamente -->
                        </select>
                        <small style="color: #666; margin-top: 5px;">Mantén Ctrl (Cmd en Mac) para seleccionar múltiples estudiantes</small>
                    </div>
                    <div style="flex-basis: 100%; display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" id="save-exam">Guardar</button>
                        <button type="button" id="cancel-exam">Cancelar</button>
                    </div>
                </form>
            </div>
            <button id="new-exam-btn" style="display: none;">Nuevo Examen</button>
        </div>
    </div>
</div>

    <div id="chatbot-view" class="view" style="display: none;">
        <div class="container" style="display: flex; gap: 20px;">
            <!-- Conversations Sidebar -->
            <div class="chatbot-sidebar" style="flex: 0 0 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Conversaciones</h3>
                    <button id="new-conversation-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Nueva</button>
                </div>
                <div id="conversations-list" style="max-height: 500px; overflow-y: auto;">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chatbot-section" style="flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                <div id="chatbot-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <h2 style="margin: 0;">Chatbot Educativo</h2>
                    <div id="conversation-actions" style="display: none;">
                        <button id="delete-conversation-btn" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Eliminar</button>
                    </div>
                </div>
                <div id="chatbot-messages" class="chat-messages" style="flex: 1; overflow-y: auto; margin-bottom: 20px;"></div>
                <div class="chat-input" id="chatbot-input-area" style="display: none;">
                    <input type="text" id="chatbot-message" placeholder="Pregunta algo sobre tus estudios..." style="flex: 1;">
                    <button id="send-chatbot" style="margin-left: 10px;">Enviar</button>
                </div>
                <div id="select-conversation-prompt" style="text-align: center; color: #666; padding: 40px;">
                    Selecciona una conversación para comenzar a chatear
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="view" style="display: none;">
        <div class="container">
            <div class="admin-section">
                <h2>Administrar Usuarios</h2>
                <div id="admin-users" class="admin-users-list"></div>
            </div>
        </div>
    </div>

<!-- Modal para tomar examen -->
<div id="exam-modal" class="exam-taking" style="display: none;">
    <div class="container">
        <div class="exam-section">
            <h2 id="exam-modal-title">Tomando Examen</h2>
            <div id="exam-timer" class="exam-timer">Tiempo restante: --:--</div>
            <div id="exam-questions" class="exam-questions"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="submit-exam-btn" class="exam-submit-btn">Enviar Examen</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para resultados del tutor -->
<div id="exam-results-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
        <button onclick="closeExamResultsModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        <h2 id="exam-results-title">Resultados del Examen</h2>
        <div id="exam-results-content"></div>
        <button onclick="closeExamResultsModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Cerrar</button>
    </div>
</div>

    <script>
        const socket = io('http://localhost:8000', {
            autoConnect: false,
            extraHeaders: {}
        });

        const loginBtn = document.getElementById('login');
        const registerBtn = document.getElementById('register');
        const connectBtn = document.getElementById('connect');
        const sendBtn = document.getElementById('send');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const tokenInput = document.getElementById('token');
        const messageInput = document.getElementById('message');
        const messagesDiv = document.getElementById('messages');

        connectBtn.addEventListener('click', () => {
            const token = tokenInput.value;
            if (!token) {
                alert('Ingresa un token JWT');
                return;
            }
            if (socket.connected) {
                socket.disconnect();
            }
            socket.auth = { token };
            socket.connect();
        });

        tokenInput.addEventListener('input', () => {
            if (tokenInput.value.trim() === '') {
                tokenInput.setAttribute('readonly', true);
            } else {
                tokenInput.removeAttribute('readonly');
            }
        });

        sendBtn.addEventListener('click', () => {
            const msg = messageInput.value;
            if (!msg) return;
            socket.emit('public-message', msg);
            messageInput.value = '';
        });

        socket.on('connect', () => {
            messagesDiv.innerHTML += '<p class="message status">Conectado al servidor</p>';
        });

        socket.on('disconnect', (reason) => {
            console.log('Usuario desconectado:', currentUser ? currentUser.username : 'N/A', 'Razón:', reason);

            // No mostrar mensaje de desconexión si está guardando proyecto, recientemente guardado o si el cliente desconectó intencionalmente
            if (reason === 'io client disconnect' || isSavingProject || isRecentlySaved) {
                // No mostrar mensaje
            } else {
                messagesDiv.innerHTML += '<p class="message status">Desconectado del servidor - Razón: ' + reason + '</p>';
            }

            // Reconectar automáticamente si hay token válido, excepto si el cliente desconectó intencionalmente
            if (reason !== 'io client disconnect' && tokenInput.value && isTokenValid(tokenInput.value)) {
                console.log('Reconectando socket automáticamente...');
                socket.auth = { token: tokenInput.value };
                socket.connect();
            }
        });

        socket.on('public-message', (data) => {
            messagesDiv.innerHTML += `<p class="message"><strong>${data.user} (${data.role}):</strong> ${data.message} <small>(${new Date(data.timestamp).toLocaleTimeString()})</small></p>`;
        });

        socket.on('connect_error', (err) => {
            messagesDiv.innerHTML += `<p class="message status">Error de conexión: ${err.message}</p>`;
        });

        socket.on('notification', (notification) => {
            showNotification(notification);
        });

        socket.on('private-message', (data) => {
            displayPrivateMessage(data);
        });

        socket.on('private-message-sent', (data) => {
            displayPrivateMessage(data);
        });

        socket.on('error', (error) => {
            console.error('Socket error:', error.message);
            alert('Error: ' + error.message);
        });

        function showNotification(notification) {
            // Add to notifications array
            notifications.unshift(notification);
            unreadNotifications++;

            // Update notification count
            updateNotificationCount();

            // Render notifications in dropdown
            renderNotifications();

            // Mostrar notificación en la UI
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification-item';
            notificationDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                padding: 15px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.5s ease-out;
            `;
            notificationDiv.innerHTML = `
                <strong>Notificación:</strong><br>
                ${notification.message}<br>
                <small>${new Date(notification.createdAt).toLocaleString()}</small>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Cerrar</button>
            `;
            document.body.appendChild(notificationDiv);

            // Auto-remover después de 10 segundos
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    notificationDiv.remove();
                }
            }, 10000);
        }

        function updateNotificationCount() {
            const countElement = document.getElementById('notification-count');
            countElement.textContent = unreadNotifications > 0 ? unreadNotifications : '';
            countElement.style.display = unreadNotifications > 0 ? 'block' : 'none';
        }

        function renderNotifications() {
            const notificationList = document.getElementById('notification-list');
            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                notificationList.innerHTML = '<li class="notification-item">No hay notificaciones</li>';
                return;
            }

            notifications.forEach((notification, index) => {
                const li = document.createElement('li');
                li.className = `notification-item ${index < unreadNotifications ? 'unread' : ''}`;
                li.innerHTML = `
                    <strong>${notification.title || 'Notificación'}</strong><br>
                    ${notification.message}<br>
                    <small>${new Date(notification.createdAt).toLocaleString()}</small>
                `;
                li.addEventListener('click', () => {
                    if (index < unreadNotifications) {
                        unreadNotifications--;
                        updateNotificationCount();
                        li.classList.remove('unread');
                    }
                });
                notificationList.appendChild(li);
            });
        }

        function displayPrivateMessage(data) {
            const privateMessagesDiv = document.getElementById('private-messages');
            const messageElement = document.createElement('p');
            messageElement.className = 'message';

            if (data.senderId === currentUser.id) {
                messageElement.innerHTML = `<strong>Tú:</strong> ${data.message} <small>(${new Date(data.timestamp).toLocaleTimeString()})</small>`;
            } else {
                messageElement.innerHTML = `<strong>${data.user}:</strong> ${data.message} <small>(${new Date(data.timestamp).toLocaleTimeString()})</small>`;
            }

            privateMessagesDiv.appendChild(messageElement);
            privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
        }

        async function loadPrivateMessages(recipientId) {
            try {
                const response = await axios.get(`http://localhost:8000/api/chat/private/${recipientId}`, { headers: getAuthHeaders() });
                const messages = response.data;
                const privateMessagesDiv = document.getElementById('private-messages');
                privateMessagesDiv.innerHTML = '';

                messages.forEach(msg => {
                    const messageElement = document.createElement('p');
                    messageElement.className = 'message';

                    if (msg.senderId === currentUser.id) {
                        messageElement.innerHTML = `<strong>Tú:</strong> ${msg.message} <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small>`;
                    } else {
                        messageElement.innerHTML = `<strong>${msg.user.username}:</strong> ${msg.message} <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small>`;
                    }

                    privateMessagesDiv.appendChild(messageElement);
                });

                privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error loading private messages:', error);
            }
        }

        async function loadUsersForPrivateChat() {
            const select = document.getElementById('private-recipient');
            select.innerHTML = '<option value="">Selecciona un destinatario</option>';

            try {
                const users = await loadUsers();
                // Filter out current user
                const availableUsers = users.filter(user => user.id !== currentUser.id);

                if (availableUsers.length === 0) {
                    select.innerHTML = '<option value="">No hay usuarios disponibles</option>';
                } else {
                    // Separate users by role
                    const tutors = availableUsers.filter(user => user.role && user.role.toLowerCase() === 'tutor');
                    const students = availableUsers.filter(user => user.role && user.role.toLowerCase() === 'alumno');

                    // Add tutors group
                    if (tutors.length > 0) {
                        const tutorGroup = document.createElement('optgroup');
                        tutorGroup.label = 'Tutores';
                        tutors.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username;
                            tutorGroup.appendChild(option);
                        });
                        select.appendChild(tutorGroup);
                    }

                    // Add students group
                    if (students.length > 0) {
                        const studentGroup = document.createElement('optgroup');
                        studentGroup.label = 'Alumnos';
                        students.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username;
                            studentGroup.appendChild(option);
                        });
                        select.appendChild(studentGroup);
                    }
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error cargando usuarios</option>';
                console.error('Error loading users for private chat:', error);
            }
        }

        // Notification bell click handler
        document.getElementById('notification-bell').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notification-dropdown');
            const bell = document.getElementById('notification-bell');
            if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Chat tab event listeners
        document.getElementById('public-tab').addEventListener('click', () => {
            switchTab('public');
        });

        document.getElementById('private-tab').addEventListener('click', () => {
            switchTab('private');
        });

        function switchTab(tab) {
            // Update tab styles
            const publicTab = document.getElementById('public-tab');
            const privateTab = document.getElementById('private-tab');

            if (tab === 'public') {
                publicTab.style.color = '#007bff';
                publicTab.style.borderBottom = '2px solid #007bff';
                publicTab.style.paddingBottom = '5px';
                privateTab.style.color = '#555';
                privateTab.style.borderBottom = 'none';
                privateTab.classList.add('private-tab-inactive');
            } else {
                privateTab.style.color = '#007bff';
                privateTab.style.borderBottom = '2px solid #007bff';
                privateTab.style.paddingBottom = '5px';
                privateTab.classList.remove('private-tab-inactive');
                publicTab.style.color = '#555';
                publicTab.style.borderBottom = 'none';
            }

            // Hide/show content
            document.getElementById('public-chat-content').style.display = tab === 'public' ? 'block' : 'none';
            document.getElementById('private-chat-content').style.display = tab === 'private' ? 'block' : 'none';

            // Load private chat data if switching to private tab
            if (tab === 'private') {
                loadUsersForPrivateChat();
            }
        }

        // Private chat event listeners
        document.getElementById('private-recipient').addEventListener('change', async (e) => {
            const recipientId = e.target.value;
            if (recipientId) {
                await loadPrivateMessages(recipientId);
            } else {
                document.getElementById('private-messages').innerHTML = '';
            }
        });

        document.getElementById('send-private').addEventListener('click', () => {
            const recipientId = document.getElementById('private-recipient').value;
            const message = document.getElementById('private-message').value;
            if (!recipientId) {
                alert('Selecciona un destinatario');
                return;
            }
            if (!message) return;
            socket.emit('private-message', { recipientId: parseInt(recipientId), message });
            document.getElementById('private-message').value = '';
        });

        let currentUser = null;
        let currentRole = null;
        let editingTaskId = null;
        let editingProjectId = null;
        let editingReminderId = null;
        let isSavingProject = false;
        let isRecentlySaved = false;
        let notifications = [];
        let unreadNotifications = 0;
        let reminders = [];

        function decodeJWT(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload;
            } catch (e) {
                return null;
            }
        }

        function isTokenValid(token) {
            try {
                const payload = decodeJWT(token);
                if (!payload || !payload.exp) return false;
                const now = Math.floor(Date.now() / 1000);
                return payload.exp > now;
            } catch (e) {
                return false;
            }
        }

        function getAuthHeaders() {
            if (!tokenInput.value) {
                alert('No hay token JWT. Por favor, inicia sesión.');
                throw new Error('No token');
            }
            if (!isTokenValid(tokenInput.value)) {
                alert('Token JWT expirado. Por favor, inicia sesión de nuevo.');
                tokenInput.value = '';
                throw new Error('Token expirado');
            }
            return { token: tokenInput.value };
        }

        async function loadUsers() {
            try {
                console.log('Iniciando carga de usuarios...');
                // Timeout reducido a 5000 ms para respuesta más rápida
                const response = await axios.get('http://localhost:8000/user/', { headers: getAuthHeaders(), timeout: 5000 });
                console.log('Respuesta recibida de usuarios:', response);
                if (!response.data || !Array.isArray(response.data)) {
                    console.error('Respuesta inesperada al cargar usuarios:', response.data);
                    alert('Error: respuesta inesperada al cargar usuarios');
                    return [];
                }
                return response.data;
            } catch (error) {
                if (error.response && error.response.status === 401) {
                    alert('Token expirado o inválido. Por favor, inicia sesión de nuevo.');
                    // Limpiar token y evitar que el dropdown se quede en cargando
                    tokenInput.value = '';
                    tokenInput.setAttribute('readonly', true);
                    // Opcional: redirigir a login o mostrar formulario login
                } else if (error.response && error.response.status === 403) {
                    alert('Acceso denegado.');
                } else if (error.code === 'ECONNABORTED') {
                    alert('Tiempo de espera agotado al cargar usuarios. Verifica que el servidor esté corriendo en http://localhost:8000');
                } else {
                    alert('Error cargando usuarios: ' + (error.response?.data?.message || error.message));
                }
                console.error('Error loading users:', error);
                return [];
            }
        }

        async function loadProjects() {
            try {
                const response = await axios.get('http://localhost:8000/projects', { headers: getAuthHeaders() });
                return response.data;
            } catch (error) {
                if (error.response && error.response.status === 401) {
                    alert('Token expirado o inválido. Por favor, inicia sesión de nuevo.');
                    tokenInput.value = '';
                    tokenInput.setAttribute('readonly', true);
                } else {
                    console.error('Error loading projects:', error);
                }
                return [];
            }
        }

        async function loadTutors() {
            try {
                const users = await loadUsers();
                return users.filter(user => user.role && user.role.toLowerCase() === 'tutor');
            } catch (error) {
                console.error('Error loading tutors:', error);
                return [];
            }
        }

        async function loadTasks() {
            try {
                const response = await axios.get('http://localhost:8000/tasks', { headers: getAuthHeaders() });
                return response.data;
            } catch (error) {
                if (error.response && error.response.status === 401) {
                    alert('Token expirado o inválido. Por favor, inicia sesión de nuevo.');
                    tokenInput.value = '';
                    tokenInput.setAttribute('readonly', true);
                } else {
                    console.error('Error loading tasks:', error);
                }
                return [];
            }
        }

        async function loadChatMessages() {
            console.log('Loading chat messages...');
            try {
                const response = await axios.get('http://localhost:8000/api/chat/messages', { headers: getAuthHeaders() });
                const messages = response.data;
                console.log('Chat messages loaded:', messages.length, 'messages');
                messagesDiv.innerHTML = ''; // Clear current messages
                messages.forEach(msg => {
                    messagesDiv.innerHTML += `<p class="message"><strong>${msg.user.username} (${msg.user.role}):</strong> ${msg.message} <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small></p>`;
                });
            } catch (error) {
                console.error('Error loading chat messages:', error.response?.status, error.response?.data, error.message);
            }
        }

        async function loadNotifications() {
            try {
                const response = await axios.get('http://localhost:8000/notifications', { headers: getAuthHeaders() });
                notifications = response.data;
                unreadNotifications = notifications.filter(n => !n.read).length;
                updateNotificationCount();
                renderNotifications();
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function loadUsersForTaskForm() {
            const select = document.getElementById('task-responsible');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const users = await loadUsers();
                const students = users.filter(user => user.role && user.role.toLowerCase() === 'alumno');
                select.innerHTML = '';
                if (students.length === 0) {
                    select.innerHTML = '<option value="">No hay alumnos</option>';
                } else {
                    students.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error cargando alumnos</option>';
                console.error('Error loading users for task form:', error);
            }
        }

        async function loadProjectsForTaskForm() {
            try {
                const projects = await loadProjects();
                const projectSelect = document.getElementById('task-project');
                projectSelect.innerHTML = '<option value="">Sin proyecto</option>';
                if (Array.isArray(projects)) {
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        projectSelect.appendChild(option);
                    });
                }
            } catch (error) {
                const projectSelect = document.getElementById('task-project');
                projectSelect.innerHTML = '<option value="">Error cargando proyectos</option>';
                console.error('Error loading projects for task form:', error);
            }
        }

        function calculateCountdown(endDate) {
            const now = new Date();
            const end = new Date(endDate);
            const diff = end - now;

            if (diff <= 0) {
                return 'Expirado';
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            return `${days} días, ${hours} horas, ${minutes} minutos`;
        }

        function renderTasks(tasks) {
            const tasksDiv = document.getElementById('tasks');
            tasksDiv.innerHTML = '';
            let filteredTasks = tasks;
            // La lógica de filtrado ya se hace en el backend, pero mantenemos una verificación por si acaso
            // if (currentRole === 'Alumno') {
            //     filteredTasks = tasks.filter(task => task.responsibleId === currentUser.id);
            // }
            if (filteredTasks.length === 0) {
                tasksDiv.innerHTML = currentRole === 'TUTOR' ? '<p>No se han creado tareas.</p>' : '<p>No tienes tareas asignadas aún.</p>';
                return;
            }
            filteredTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';

                // Determinar cómo mostrar el alumno asignado
                let assignedStudentText = '';
                if (currentRole === 'TUTOR' && task.responsibles) {
                    // Para tutores: mostrar lista de alumnos asignados
                    const responsiblesList = task.responsibles.map(r => r.username).join(', ');
                    assignedStudentText = responsiblesList || 'N/A';
                } else {
                    // Para alumnos: mostrar el alumno asignado individual
                    assignedStudentText = task.responsible?.username || 'N/A';
                }

                taskDiv.innerHTML = `
                    <h4>${task.name} (${task.type === 'daily' ? 'Diaria' : 'Proyecto'})</h4>
                    <p>${task.description || ''}</p>
                    <p>Tutor: ${task.tutor?.username || 'Tutor no asignado'}</p>
                    <p>Alumno asignado: ${assignedStudentText}</p>
                    <p>Estado: ${task.status}</p>
                    <p>Prioridad: ${task.priority}</p>
            ${task.dueDate ? `<p>Fecha límite: ${new Date(task.dueDate).toLocaleDateString()} - Cuenta regresiva: ${calculateCountdown(task.dueDate)}</p>` : ''}
            ${currentRole === 'TUTOR' ? `<button onclick="editTask(${task.id})">Editar</button> <button onclick="deleteTask(${task.id})">Eliminar</button>` : ''}
            ${currentRole === 'ALUMNO' && task.responsibleId === currentUser.id ? `<button class="task-submit-btn" onclick="openSubmissionModal('task', ${task.id})">Realizar Entrega</button>` : ''}
                `;
                tasksDiv.appendChild(taskDiv);
            });
        }

        function renderProjects(projects, tasks = []) {
            const projectsDiv = document.getElementById('projects');
            projectsDiv.innerHTML = '';
            let filteredProjects = projects;
            // La lógica de filtrado ya se hace en el backend
            if (filteredProjects.length === 0) {
                projectsDiv.innerHTML = currentRole === 'ALUMNO' ? '<p>No tienes proyectos asignados aún.</p>' : '<p>No hay proyectos disponibles.</p>';
                return;
            }
            filteredProjects.forEach(project => {
                console.log('Project tutor property:', project.tutor);
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-item';
                const participantsList = project.participants && project.participants.length > 0 ? project.participants.map(p => p.username).join(', ') : 'Ninguno';
                // Fix tutor display: show tutor username if available, else 'N/A'
                const tutorName = project.tutor && project.tutor.username ? project.tutor.username : 'N/A';
                projectDiv.innerHTML = `
                    <h4>${project.name}</h4>
                    <p>${project.description || ''}</p>
                    <p>Estado: ${project.status}</p>
                    <p>Tutor: ${tutorName}</p>
                    <p>Participantes: ${participantsList}</p>
                    ${project.startDate ? `<p>Inicio: ${new Date(project.startDate).toLocaleString()}</p>` : ''}
                    ${project.endDate ? `<p>Fin: ${new Date(project.endDate).toLocaleString()}</p>` : ''}
                    ${project.endDate ? `<p>Cuenta regresiva: ${calculateCountdown(project.endDate)}</p>` : ''}
                    ${currentRole === 'TUTOR' ? `<button onclick="editProject(${project.id})">Editar</button> <button onclick="deleteProject(${project.id})">Eliminar</button>` : ''}
                `;
                projectsDiv.appendChild(projectDiv);
            });
        }

        async function refreshData() {
            console.log('Iniciando refreshData...');
            try {
                const [tasks, projects] = await Promise.all([loadTasks(), loadProjects()]);
                console.log('Datos cargados exitosamente:', { tasksCount: tasks.length, projectsCount: projects.length });
                renderTasks(tasks);
                renderProjects(projects, tasks);
                console.log('Datos renderizados exitosamente');
            } catch (error) {
                console.error('Error en refreshData:', error);
                // Don't re-throw to prevent cascading errors
            }
        }

        // Función para manejar la autenticación exitosa
        async function handleSuccessfulAuth(token, user) {
            tokenInput.value = token;
            tokenInput.removeAttribute('readonly');
            currentUser = user;
            currentRole = user.role;
            messagesDiv.innerHTML += '<p class="message status">Login exitoso, token obtenido</p>';

            // Actualizar información del usuario en la UI
            document.getElementById('user-name').textContent = user.username;
            document.getElementById('user-role').textContent = user.role;

            // Conectar socket automáticamente
            if (socket.connected) {
                socket.disconnect();
            }
            socket.auth = { token };
            socket.connect();

            // Mostrar/ocultar botones según rol
            console.log('Rol actual:', currentRole);
            document.getElementById('new-task-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';
            document.getElementById('new-project-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';
            document.getElementById('new-exam-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';

            // Cargar datos iniciales
            await refreshData();

            // Ocultar login y mostrar app principal
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            // Mostrar vista de chat y cargar mensajes
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('chat-view').style.display = 'block';
            await loadChatMessages();
            await loadNotifications();
        }

        // Verificar si hay un token en la URL (para autenticación de Google)
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                // Limpiar la URL
                window.history.replaceState({}, document.title, window.location.pathname);
                const user = decodeJWT(token);
                handleSuccessfulAuth(token, user);
            }
        };

        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (!username || !password) {
                alert('Ingresa usuario y contraseña');
                return;
            }
            try {
                const response = await axios.post('http://localhost:8000/auth/login', {
                    username,
                    password,
                    role: document.getElementById('role') ? document.getElementById('role').value : undefined
                });
                const token = response.headers['token'] || response.data.token || response.headers.token;
                const user = decodeJWT(token);
                await handleSuccessfulAuth(token, user);

                // Conectar socket automáticamente
                if (socket.connected) {
                    socket.disconnect();
                }
                socket.auth = { token };
                socket.connect();

                // Mostrar/ocultar botones según rol
                document.getElementById('new-task-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';
                document.getElementById('new-project-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';
                document.getElementById('new-exam-btn').style.display = currentRole === 'TUTOR' ? 'block' : 'none';

                // Asegurarse que las vistas de listas son visibles y los formularios de creación ocultos
                document.getElementById('tasks').style.display = 'block';
                document.getElementById('projects').style.display = 'block';
                document.getElementById('create-task').style.display = 'none';
                document.getElementById('create-project').style.display = 'none';

                // Cargar datos
                await refreshData();

                // Ocultar login y mostrar app principal
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                // Mostrar vista de chat y cargar mensajes al iniciar sesión
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                document.getElementById('chat-view').style.display = 'block';
                await loadChatMessages();
                await loadNotifications();
            } catch (error) {
                messagesDiv.innerHTML += `<p>Error en login: ${error.response?.data?.message || error.message}</p>`;
            }
        });

        registerBtn.addEventListener('click', async () => {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const email = document.getElementById('reg-email').value;
            const firstName = document.getElementById('reg-firstname').value;
            const lastName = document.getElementById('reg-lastname').value;
            const role = document.getElementById('reg-role').value;
            if (!username || !password || !email || !firstName || !lastName || !role) {
                alert('Ingresa todos los campos requeridos');
                return;
            }
            try {
                const response = await axios.post('http://localhost:8000/auth/register', {
                    username,
                    password,
                    email,
                    firstName,
                    lastName,
                    role
                });
                alert('Registro exitoso. Ahora puedes iniciar sesión.');
                // Clear form
                document.getElementById('reg-username').value = '';
                document.getElementById('reg-password').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-firstname').value = '';
                document.getElementById('reg-lastname').value = '';
                document.getElementById('reg-role').value = 'Alumno';
            } catch (error) {
                alert('Error en registro: ' + (error.response?.data?.message || error.message));
            }
        });

        // Event listeners para tareas
        document.getElementById('new-task-btn').addEventListener('click', async () => {
            document.getElementById('create-task').style.display = 'block';
            const select = document.getElementById('task-responsible');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                console.log('Cargando usuarios para dropdown...');
                const users = await loadUsers();
                console.log('Usuarios recibidos:', users);
                const students = users.filter(user => user.role && user.role.toLowerCase() === 'alumno');
                console.log('Alumnos filtrados:', students);
                select.innerHTML = '';
                if (students.length === 0) {
                    select.innerHTML = '<option value="">No hay alumnos</option>';
                } else {
                    students.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error cargando alumnos</option>';
                console.error('Error loading users:', error);
            }
                try {
                    const projects = await loadProjects();
                    const projectSelect = document.getElementById('task-project');
                    projectSelect.innerHTML = '<option value="">Sin proyecto</option>';
                    if (Array.isArray(projects)) {
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.id;
                            option.textContent = project.name;
                            projectSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    const projectSelect = document.getElementById('task-project');
                    projectSelect.innerHTML = '<option value="">Error cargando proyectos</option>';
                    console.error('Error loading projects:', error);
                }
        });

        document.getElementById('task-type').addEventListener('change', (e) => {
            document.getElementById('project-field').style.display = e.target.value === 'project' ? 'block' : 'none';
        });

        document.getElementById('save-task').addEventListener('click', async () => {
            const type = document.getElementById('task-type').value;
            const name = document.getElementById('task-name').value.trim();
            const description = document.getElementById('task-description').value;
            const responsibleId = document.getElementById('task-responsible').value;
            const tutorId = currentUser.id;
            const projectId = type === 'project' ? document.getElementById('task-project').value : null;
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const status = document.getElementById('task-status').value;

            if (!name) {
                alert('Ingresa nombre de la tarea');
                return;
            }
            if (!responsibleId) {
                alert('Selecciona alumno');
                return;
            }
            if (!priority) {
                alert('Selecciona prioridad');
                return;
            }
            if (!type) {
                alert('Selecciona tipo de tarea');
                return;
            }
            if (type === 'project' && !projectId) {
                alert('Selecciona proyecto para tarea de proyecto');
                return;
            }

            try {
                const taskData = {
                    name,
                    description: description || null,
                    responsibleId: parseInt(responsibleId),
                    tutorId: parseInt(tutorId),
                    priority,
                    type,
                    status
                };
                if (dueDate) {
                    taskData.dueDate = dueDate;
                }
                if (projectId) {
                    taskData.projectId = parseInt(projectId);
                }

                if (editingTaskId) {
                    // Update existing task
                    const res = await axios.put(`http://localhost:8000/tasks/${editingTaskId}`, taskData, { headers: getAuthHeaders() });
                    alert('Tarea actualizada exitosamente');
                    // Check for optional calendar warning from server
                    if (res?.data?.calendarWarning) {
                        const msg = res.data.calendarWarning;
                        const code = res.data.calendarWarningCode;
                        // If insufficient permissions, offer immediate re-consent
                        if (code === 'INSUFFICIENT_PERMISSIONS') {
                            if (confirm(msg + '\n\n¿Pedir re-consentimiento ahora?')) {
                                window.location.href = 'http://localhost:8000/auth/google';
                            }
                        } else {
                            alert(msg);
                        }
                    }
                } else {
                    // Create new task
                    const res = await axios.post('http://localhost:8000/tasks', taskData, { headers: getAuthHeaders() });
                    alert('Tarea creada exitosamente');
                    // If server returned calendar warning, surface it and offer re-consent when needed
                    if (res?.data?.calendarWarning) {
                        const msg = res.data.calendarWarning;
                        const code = res.data.calendarWarningCode;
                        if (code === 'INSUFFICIENT_PERMISSIONS') {
                            if (confirm(msg + '\n\n¿Pedir re-consentimiento ahora?')) {
                                window.location.href = 'http://localhost:8000/auth/google';
                            }
                        } else {
                            alert(msg);
                        }
                    }
                }

                // Reset form and hide
                editingTaskId = null;
                document.getElementById('task-form-title').textContent = 'Crear Tarea';
                document.getElementById('create-task').style.display = 'none';
                await refreshData();
            } catch (error) {
                console.error('Error guardando tarea:', error);
                alert('Error guardando tarea: ' + (error.response?.data?.message || error.message || 'Error desconocido'));
            }
        });

        document.getElementById('cancel-task').addEventListener('click', () => {
            document.getElementById('create-task').style.display = 'none';
        });

        // Similar para proyectos
        document.getElementById('new-project-btn').addEventListener('click', async () => {
            editingProjectId = null; // Reiniciar para crear nuevo proyecto
            document.getElementById('project-form-title').textContent = 'Crear Proyecto';

            // Limpiar formulario
            document.getElementById('project-name').value = '';
            document.getElementById('project-description').value = '';
            document.getElementById('project-start-date').value = '';
            document.getElementById('project-end-date').value = '';
            document.getElementById('project-status').value = 'Planificación';

            // Mostrar formulario
            document.getElementById('create-project').style.display = 'block';

            // Load users for participants dropdown with loading state
            const participantsSelect = document.getElementById('project-participants');
            participantsSelect.innerHTML = '<option value="">Cargando...</option>';
            try {
                const users = await loadUsers();
                const students = users.filter(user => user.role && user.role.toLowerCase() === 'alumno');
                participantsSelect.innerHTML = '';
                if (students.length === 0) {
                    participantsSelect.innerHTML = '<option value="">No hay alumnos</option>';
                } else {
                    students.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        participantsSelect.appendChild(option);
                    });
                }
            } catch (error) {
                participantsSelect.innerHTML = '<option value="">Error cargando alumnos</option>';
                console.error('Error loading users for project form:', error);
            }
        });

        document.getElementById('save-project').addEventListener('click', async () => {
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-description').value;
            const startDate = document.getElementById('project-start-date').value;
            const endDate = document.getElementById('project-end-date').value;
            const status = document.getElementById('project-status').value;
            const participantsSelect = document.getElementById('project-participants');

            // Get selected participant as a single number
            const selectedParticipant = parseInt(participantsSelect.value);
            const tutorId = currentUser.id;

            if (!name) {
                alert('Ingresa nombre del proyecto');
                return;
            }
            if (isNaN(selectedParticipant)) {
                alert('Selecciona un alumno para el proyecto');
                return;
            }

            try {
                const projectData = {
                    name,
                    description: description || null,
                    startDate: startDate || null,
                    endDate: endDate || null,
                    status,
                    participants: [selectedParticipant], // Enviar como array con un solo alumno
                    tutorId: parseInt(currentUser.id)
                };

                if (editingProjectId) {
                    // Update existing project
                    await axios.put(`http://localhost:8000/projects/${editingProjectId}`, projectData, { headers: getAuthHeaders() });
                    alert('Proyecto actualizado exitosamente');
                } else {
                    // Create new project
                    await axios.post('http://localhost:8000/projects', projectData, { headers: getAuthHeaders() });
                    alert('Proyecto creado exitosamente');
                }

                // Reset form and hide
                editingProjectId = null;
                document.getElementById('project-form-title').textContent = 'Crear Proyecto';
                document.getElementById('create-project').style.display = 'none';
                await refreshData();
            } catch (error) {
                console.error('Error guardando proyecto:', error);
                alert('Error guardando proyecto: ' + (error.response?.data?.message || error.message || 'Error desconocido'));
            }
        });

        document.getElementById('cancel-project').addEventListener('click', () => {
            document.getElementById('create-project').style.display = 'none';
        });

        // Event listeners para navegación
        document.getElementById('show-chat').addEventListener('click', async () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('chat-view').style.display = 'block';
            await loadChatMessages();
        });

        document.getElementById('show-tasks').addEventListener('click', () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('tasks-view').style.display = 'block';
        });

        document.getElementById('show-projects').addEventListener('click', () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('projects-view').style.display = 'block';
        });

        document.getElementById('show-reports').addEventListener('click', () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('reports-view').style.display = 'block';
        });

        document.getElementById('show-reminders').addEventListener('click', () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('reminders-view').style.display = 'block';
            loadReminders();
        });

        document.getElementById('show-exams').addEventListener('click', () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('exams-view').style.display = 'block';
            loadExams();
        });

        // Exam functionality
        async function loadExams() {
            try {
                let response;
                if (currentRole === 'TUTOR') {
                        response = await axios.get('http://localhost:8000/exams/tutor', { headers: getAuthHeaders() });
                    } else {
                        response = await axios.get('http://localhost:8000/exams/student', { headers: getAuthHeaders() });
                }
                const exams = response.data;
                renderExams(exams);
            } catch (error) {
                console.error('Error loading exams:', error);
                if (error.response && error.response.status === 401) {
                    alert('Token expirado. Por favor, inicia sesión de nuevo.');
                    logout();
                } else {
                    alert('Error cargando exámenes: ' + (error.response?.data?.message || error.message));
                }
            }
        }

        function renderExams(exams) {
            const examsDiv = document.getElementById('exams');
            examsDiv.innerHTML = '';
            if (!exams || exams.length === 0) {
                examsDiv.innerHTML = currentRole === 'TUTOR' ? '<p>No has creado exámenes aún.</p>' : '<p>No tienes exámenes asignados aún.</p>';
                return;
            }

            exams.forEach(exam => {
                const examDiv = document.createElement('div');
                examDiv.className = 'exam-item';
                const assignedUsers = exam.assignedUsers && exam.assignedUsers.length > 0 ? exam.assignedUsers.map(u => u.username).join(', ') : 'Ninguno';
                const topics = exam.topics ? JSON.parse(exam.topics).join(', ') : '';

                if (currentRole === 'TUTOR') {
                    examDiv.innerHTML = `
                        <h4>${exam.title}</h4>
                        <p>Temas: ${topics}</p>
                        <p>Preguntas: ${exam.numQuestions}</p>
                        <p>Tiempo límite: ${exam.timeLimit} minutos</p>
                        <p>Asignados: ${assignedUsers}</p>
                        <button onclick="viewExamResults(${exam.id})">Ver Resultados</button>
                        <button onclick="deleteExam(${exam.id})">Eliminar</button>
                    `;
                } else {
                    const isCompleted = exam.submissions && exam.submissions.some(s => s.studentId === currentUser.id);
                    examDiv.innerHTML = `
                        <h4>${exam.title}</h4>
                        <p>Temas: ${topics}</p>
                        <p>Preguntas: ${exam.numQuestions}</p>
                        <p>Tiempo límite: ${exam.timeLimit} minutos</p>
                        <p>Estado: ${isCompleted ? 'Completado' : 'Pendiente'}</p>
                        ${!isCompleted ? `<button onclick="takeExam(${exam.id})">Tomar Examen</button>` : '<p>Examen completado</p>'}
                    `;
                }
                examsDiv.appendChild(examDiv);
            });
        }

        // Load users for exam assignment
        async function loadUsersForExamForm() {
            const select = document.getElementById('exam-assigned-to');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const users = await loadUsers();
                const students = users.filter(user => user.role && user.role.toLowerCase() === 'alumno');
                select.innerHTML = '';
                if (students.length === 0) {
                    select.innerHTML = '<option value="">No hay alumnos</option>';
                } else {
                    students.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error cargando alumnos</option>';
                console.error('Error loading users for exam form:', error);
            }
        }

        // New exam button event
        document.getElementById('new-exam-btn').addEventListener('click', async () => {
            document.getElementById('create-exam').style.display = 'block';
            await loadUsersForExamForm();
        });

        // Save exam event
        document.getElementById('save-exam').addEventListener('click', async () => {
            const title = document.getElementById('exam-title').value.trim();
            const topics = document.getElementById('exam-topics').value.trim();
            const numQuestions = parseInt(document.getElementById('exam-num-questions').value);
            const timeLimit = parseInt(document.getElementById('exam-time-limit').value);
            const assignedToSelect = document.getElementById('exam-assigned-to');
            const assignedTo = Array.from(assignedToSelect.selectedOptions).map(option => parseInt(option.value));

            if (!title || !topics || !numQuestions || !timeLimit || assignedTo.length === 0) {
                alert('Completa todos los campos requeridos');
                return;
            }

            try {
                const examData = {
                    title,
                    topics,
                    numQuestions,
                    timeLimit,
                    assignedTo
                };

                await axios.post('http://localhost:8000/exams', examData, { headers: getAuthHeaders() });
                alert('Examen creado exitosamente');

                document.getElementById('create-exam').style.display = 'none';
                document.getElementById('exam-title').value = '';
                document.getElementById('exam-topics').value = '';
                document.getElementById('exam-num-questions').value = '';
                document.getElementById('exam-time-limit').value = '';
                document.getElementById('exam-assigned-to').selectedIndex = -1;

                await loadExams();
            } catch (error) {
                console.error('Error creando examen:', error);
                alert('Error creando examen: ' + (error.response?.data?.message || error.message));
            }
        });

        // Cancel exam event
        document.getElementById('cancel-exam').addEventListener('click', () => {
            document.getElementById('create-exam').style.display = 'none';
        });

        // Take exam function
        async function takeExam(examId) {
            try {
                const response = await axios.get(`http://localhost:8000/exams/${examId}/questions`, { headers: getAuthHeaders() });
                const examData = response.data;
                currentExam = examData;
                currentExamId = examId;
                renderExamQuestions(examData.questions);
                startExamTimer(examData.timeLimit);
                document.getElementById('exam-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading exam questions:', error);
                alert('Error cargando preguntas del examen: ' + (error.response?.data?.message || error.message));
            }
        }

        let currentExam = null;
        let currentExamId = null;
        let examTimer = null;
        let examTimeLeft = 0;

        function renderExamQuestions(questions) {
            const questionsDiv = document.getElementById('exam-questions');
            questionsDiv.innerHTML = '';

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'exam-question';
                let optionsHtml = '';

                if (question.type === 'multiple_choice' && question.options) {
                    optionsHtml = question.options.map((option, optIndex) => `
                        <label class="exam-option">
                            <input type="radio" name="question-${index}" value="${optIndex}" required>
                            ${option}
                        </label>
                    `).join('');
                } else if (question.type === 'true_false') {
                    optionsHtml = `
                        <label class="exam-option">
                            <input type="radio" name="question-${index}" value="true" required>
                            Verdadero
                        </label>
                        <label class="exam-option">
                            <input type="radio" name="question-${index}" value="false" required>
                            Falso
                        </label>
                    `;
                } else if (question.type === 'open_ended') {
                    optionsHtml = `
                        <textarea name="question-${index}" rows="4" cols="50" placeholder="Escribe tu respuesta aquí..." required></textarea>
                    `;
                }

                questionDiv.innerHTML = `
                    <h4>Pregunta ${index + 1}</h4>
                    <p>${question.question}</p>
                    <div class="exam-options">
                        ${optionsHtml}
                    </div>
                `;
                questionsDiv.appendChild(questionDiv);
            });
        }

        function startExamTimer(timeLimit) {
            examTimeLeft = timeLimit * 60; // Convert to seconds
            updateExamTimer();

            examTimer = setInterval(() => {
                examTimeLeft--;
                updateExamTimer();

                if (examTimeLeft <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                }
            }, 1000);
        }

        function updateExamTimer() {
            const minutes = Math.floor(examTimeLeft / 60);
            const seconds = examTimeLeft % 60;
            document.getElementById('exam-timer').textContent = `Tiempo restante: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Submit exam event
        document.getElementById('submit-exam-btn').addEventListener('click', submitExam);

        async function submitExam() {
            if (examTimer) {
                clearInterval(examTimer);
            }

            // Validar que todas las preguntas estén respondidas
            let allAnswered = true;
            const answers = {};

            currentExam.questions.forEach((question, index) => {
                let answer = null;

                if (question.type === 'open_ended') {
                    // Para preguntas abiertas, buscar textarea
                    const textarea = document.querySelector(`textarea[name="question-${index}"]`);
                    if (textarea && textarea.value.trim()) {
                        answer = textarea.value.trim();
                    }
                } else {
                    // Para preguntas de opción múltiple y verdadero/falso, buscar radio button seleccionado
                    const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                    if (selectedOption) {
                        if (question.type === 'multiple_choice') {
                            // Para múltiple choice, enviar el texto completo de la opción seleccionada
                            const selectedIndex = parseInt(selectedOption.value);
                            answer = question.options[selectedIndex];
                        } else {
                            // Para verdadero/falso, enviar el valor directamente
                            answer = selectedOption.value;
                        }
                    }
                }

                if (answer) {
                    answers[question.id.toString()] = answer;
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert('Por favor responde todas las preguntas antes de enviar el examen.');
                return;
            }

            try {
                await axios.post('http://localhost:8000/exams/submit', { examId: currentExamId, answers }, { headers: getAuthHeaders() });
                alert('Examen enviado exitosamente');
                document.getElementById('exam-modal').style.display = 'none';
                await loadExams();
            } catch (error) {
                console.error('Error submitting exam:', error);
                alert('Error enviando examen: ' + (error.response?.data?.message || error.message));
            }
        }

        // View exam results for tutor
        async function viewExamResults(examId) {
            try {
                const response = await axios.get(`http://localhost:8000/exams/${examId}/results`, { headers: getAuthHeaders() });
                const results = response.data;
                renderExamResults(results);
                document.getElementById('exam-results-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading exam results:', error);
                alert('Error cargando resultados: ' + (error.response?.data?.message || error.message));
            }
        }

        function renderExamResults(results) {
            const resultsDiv = document.getElementById('exam-results-content');
            resultsDiv.innerHTML = '';

            if (!results || !results.submissions || results.submissions.length === 0) {
                resultsDiv.innerHTML = '<p>No hay resultados disponibles aún.</p>';
                return;
            }

            results.submissions.forEach(submission => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'exam-results';
                resultDiv.innerHTML = `
                    <h4>Estudiante: ${submission.student.username}</h4>
                    <p>Puntuación: ${submission.score.toFixed(1)}/5.0</p>
                    <p>Porcentaje: ${((submission.score / 5.0) * 100).toFixed(2)}%</p>
                    <p>Fecha de envío: ${new Date(submission.submittedAt).toLocaleString()}</p>
                `;
                resultsDiv.appendChild(resultDiv);
            });
        }

        function closeExamResultsModal() {
            document.getElementById('exam-results-modal').style.display = 'none';
        }

        // Delete exam function
        async function deleteExam(examId) {
            if (confirm('¿Eliminar examen? Esta acción no se puede deshacer.')) {
                try {
                    await axios.delete(`http://localhost:8000/exams/${examId}`, { headers: getAuthHeaders() });
                    alert('Examen eliminado exitosamente');
                    await loadExams();
                } catch (error) {
                    console.error('Error deleting exam:', error);
                    alert('Error eliminando examen: ' + (error.response?.data?.message || error.message));
                }
            }
        }

        // Update login to show exam button for tutors
        // In the login event listener, add:
        // document.getElementById('new-exam-btn').style.display = currentRole === 'Tutor' ? 'block' : 'none';

        async function loadReminders() {
            try {
                const response = await axios.get('http://localhost:8000/reminders', { headers: getAuthHeaders() });
                reminders = response.data;
                renderReminders();
            } catch (error) {
                console.error('Error loading reminders:', error);
                if (error.response && error.response.status === 401) {
                    alert('Token expirado. Por favor, inicia sesión de nuevo.');
                    logout();
                } else {
                    alert('Error cargando recordatorios: ' + (error.response?.data?.message || error.message));
                }
            }
        }

        function renderReminders() {
            const remindersDiv = document.getElementById('reminders');
            remindersDiv.innerHTML = '';
            if (!reminders || !Array.isArray(reminders) || reminders.length === 0) {
                remindersDiv.innerHTML = '<p>No tienes recordatorios aún.</p>';
                return;
            }
            reminders.forEach(reminder => {
                const reminderDiv = document.createElement('div');
                reminderDiv.className = 'reminder-item';
                const scheduledDate = new Date(reminder.scheduledAt);
                const now = new Date();
                const isPast = scheduledDate < now;
                const timeLeft = isPast ? 'Expirado' : calculateCountdown(reminder.scheduledAt);

                reminderDiv.innerHTML = `
                    <h4>${reminder.title}</h4>
                    <p>${reminder.description || ''}</p>
                    <p>Fecha programada: ${scheduledDate.toLocaleString()}</p>
                    <p>Tiempo restante: ${timeLeft}</p>
                    <p>Estado: ${reminder.isActive ? 'Activo' : 'Inactivo'}</p>
                    ${reminder.relatedId ? `<p>Relacionado con: ${reminder.relatedType === 'task' ? 'Tarea' : 'Proyecto'} ID ${reminder.relatedId}</p>` : ''}
                    <button onclick="editReminder(${reminder.id})">Editar</button>
                    <button onclick="deleteReminder(${reminder.id})">Eliminar</button>
                    <button onclick="toggleReminderStatus(${reminder.id}, ${reminder.isActive})">${reminder.isActive ? 'Desactivar' : 'Activar'}</button>
                `;
                remindersDiv.appendChild(reminderDiv);
            });
        }

        async function saveReminder() {
            const title = document.getElementById('reminder-title').value.trim();
            const description = document.getElementById('reminder-description').value;
            const scheduledAt = document.getElementById('reminder-date').value;

            if (!title || !scheduledAt) {
                alert('Ingresa título y fecha');
                return;
            }

            const scheduledDate = new Date(scheduledAt);
            if (scheduledDate <= new Date()) {
                alert('La fecha debe ser futura');
                return;
            }

            const reminderData = {
                title,
                description: description || null,
                scheduledAt
            };

            try {
                if (editingReminderId) {
                    await axios.put(`http://localhost:8000/reminders/${editingReminderId}`, reminderData, { headers: getAuthHeaders() });
                    alert('Recordatorio actualizado exitosamente');
                } else {
                    await axios.post('http://localhost:8000/reminders', reminderData, { headers: getAuthHeaders() });
                    alert('Recordatorio creado exitosamente');
                }

                document.getElementById('create-reminder').style.display = 'none';
                editingReminderId = null;
                document.getElementById('reminder-form-title').textContent = 'Crear Recordatorio';
                await loadReminders();
            } catch (error) {
                alert('Error guardando recordatorio: ' + (error.response?.data?.message || error.message));
            }
        }

        async function toggleReminderStatus(id, currentStatus) {
            try {
                const newStatus = !currentStatus;
                await axios.put(`http://localhost:8000/reminders/${id}`, { isActive: newStatus }, { headers: getAuthHeaders() });
                alert(`Recordatorio ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
                await loadReminders();
            } catch (error) {
                alert('Error cambiando estado del recordatorio: ' + (error.response?.data?.message || error.message));
            }
        }

        // Reminder form submission
        document.getElementById('reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveReminder();
        });

        document.getElementById('cancel-reminder').addEventListener('click', () => {
            document.getElementById('create-reminder').style.display = 'none';
            editingReminderId = null;
            document.getElementById('reminder-form-title').textContent = 'Crear Recordatorio';
        });

        document.getElementById('new-reminder-btn').addEventListener('click', () => {
            editingReminderId = null;
            document.getElementById('reminder-form-title').textContent = 'Crear Recordatorio';
            document.getElementById('reminder-title').value = '';
            document.getElementById('reminder-description').value = '';
            document.getElementById('reminder-date').value = '';
            document.getElementById('create-reminder').style.display = 'block';
        });

        // Global functions for editing/deleting reminders
        window.editReminder = async (id) => {
            try {
                const response = await axios.get(`http://localhost:8000/reminders/${id}`, { headers: getAuthHeaders() });
                const reminder = response.data;

                editingReminderId = id;
                document.getElementById('reminder-form-title').textContent = 'Editar Recordatorio';
                document.getElementById('reminder-title').value = reminder.title;
                document.getElementById('reminder-description').value = reminder.description || '';
                document.getElementById('reminder-date').value = new Date(reminder.scheduledAt).toISOString().slice(0,16);
                document.getElementById('create-reminder').style.display = 'block';
            } catch (error) {
                alert('Error cargando recordatorio: ' + (error.response?.data?.message || error.message));
            }
        };

        window.deleteReminder = async (id) => {
            if (confirm('¿Eliminar recordatorio?')) {
                try {
                    await axios.delete(`http://localhost:8000/reminders/${id}`, { headers: getAuthHeaders() });
                    alert('Recordatorio eliminado exitosamente');
                    await loadReminders();
                } catch (error) {
                    alert('Error eliminando recordatorio: ' + (error.response?.data?.message || error.message));
                }
            }
        };

        window.toggleReminderStatus = toggleReminderStatus;

        document.getElementById('logout').addEventListener('click', () => {
            // Limpiar datos de usuario
            currentUser = null;
            currentRole = null;
            tokenInput.value = '';
            tokenInput.setAttribute('readonly', true);
            usernameInput.value = '';
            passwordInput.value = '';

            // Ocultar app principal y mostrar login
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';

            // Desconectar socket si está conectado
            if (socket.connected) {
                socket.disconnect();
            }

            // Limpiar mensajes
            messagesDiv.innerHTML = '';
        });

        // Funciones globales para editar/eliminar
        window.editTask = async (id) => {
            try {
                const response = await axios.get(`http://localhost:8000/tasks/${id}`, { headers: getAuthHeaders() });
                const task = response.data;

                // Set editing mode
                editingTaskId = id;
                document.getElementById('task-form-title').textContent = 'Editar Tarea';

                // Populate form
                document.getElementById('task-type').value = task.type;
                document.getElementById('task-name').value = task.name;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-responsible').value = task.responsibleId;
                document.getElementById('task-project').value = task.projectId || '';
                document.getElementById('task-due-date').value = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-status').value = task.status;

                // Show project field if task type is project
                document.getElementById('project-field').style.display = task.type === 'project' ? 'block' : 'none';

                // Load dropdowns
                await loadUsersForTaskForm();
                await loadProjectsForTaskForm();

                // Show form
                document.getElementById('create-task').style.display = 'block';
            } catch (error) {
                alert('Error cargando tarea: ' + (error.response?.data?.message || error.message));
            }
        };

        window.deleteTask = async (id) => {
            if (confirm('¿Eliminar tarea?')) {
                try {
                    await axios.delete(`http://localhost:8000/tasks/${id}`, { headers: getAuthHeaders() });
                    await refreshData();
                } catch (error) {
                    alert('Error eliminando tarea');
                }
            }
        };

        window.editProject = async (id) => {
            try {
                const response = await axios.get(`http://localhost:8000/projects/${id}`, { headers: getAuthHeaders() });
                const project = response.data;

                // Set editing mode
                editingProjectId = id;
                document.getElementById('project-form-title').textContent = 'Editar Proyecto';

                // Populate form
                document.getElementById('project-name').value = project.name;
                document.getElementById('project-description').value = project.description || '';
                document.getElementById('project-start-date').value = project.startDate ? new Date(project.startDate).toISOString().slice(0,16) : '';
                document.getElementById('project-end-date').value = project.endDate ? new Date(project.endDate).toISOString().slice(0,16) : '';
                document.getElementById('project-status').value = project.status;

                // Load participants
                const participantsSelect = document.getElementById('project-participants');
                participantsSelect.innerHTML = '';
                try {
                    const users = await loadUsers();
                    const students = users.filter(user => user.role && user.role.toLowerCase() === 'alumno');
                    if (students.length === 0) {
                        participantsSelect.innerHTML = '<option value="">No hay alumnos</option>';
                    } else {
                        students.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username;
                            // Pre-select participants
                            if (project.participants && project.participants.some(p => p.id === user.id)) {
                                option.selected = true;
                            }
                            participantsSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading users for project edit:', error);
                }

                // Show form
                document.getElementById('create-project').style.display = 'block';
            } catch (error) {
                alert('Error cargando proyecto: ' + (error.response?.data?.message || error.message));
            }
        };

        window.deleteProject = async (id) => {
            if (confirm('¿Eliminar proyecto?')) {
                try {
                    await axios.delete(`http://localhost:8000/projects/${id}`, { headers: getAuthHeaders() });
                    await refreshData();
                } catch (error) {
                    alert('Error eliminando proyecto');
                }
            }
        };

        // Submission modal functions
        let currentSubmissionType = null;
        let currentSubmissionId = null;
        let selectedFiles = [];

        // Chatbot variables
        let currentConversationId = null;
        let chatbotConversations = [];

        // Load chatbot conversations
        async function loadConversations() {
            try {
                const response = await axios.get('http://localhost:8000/chatbot/conversations', { headers: getAuthHeaders() });
                chatbotConversations = response.data;
                renderConversations();
            } catch (error) {
                console.error('Error loading conversations:', error);
                if (error.response && error.response.status === 401) {
                    alert('Token expirado. Por favor, inicia sesión de nuevo.');
                    logout();
                } else {
                    alert('Error cargando conversaciones: ' + (error.response?.data?.message || error.message));
                }
            }
        }

        // Render conversations list
        function renderConversations() {
            const conversationsList = document.getElementById('conversations-list');
            conversationsList.innerHTML = '';

            if (!chatbotConversations || chatbotConversations.length === 0) {
                conversationsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No tienes conversaciones aún.<br>Crea una nueva para comenzar.</p>';
                return;
            }

            chatbotConversations.forEach(conversation => {
                const conversationDiv = document.createElement('div');
                conversationDiv.className = 'conversation-item';
                conversationDiv.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    cursor: pointer;
                    background: ${conversation.id === currentConversationId ? '#e3f2fd' : '#f9f9f9'};
                `;
                conversationDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${conversation.title}</div>
                    <div style="font-size: 12px; color: #666;">${new Date(conversation.updatedAt).toLocaleString()}</div>
                    <div style="font-size: 12px; color: #666;">${conversation.messages ? conversation.messages.length : 0} mensajes</div>
                `;
                conversationDiv.addEventListener('click', () => selectConversation(conversation.id));
                conversationsList.appendChild(conversationDiv);
            });
        }

        // Create new conversation
        async function createNewConversation() {
            try {
                const response = await axios.post('http://localhost:8000/chatbot/conversations', {}, { headers: getAuthHeaders() });
                const newConversation = response.data;
                chatbotConversations.unshift(newConversation);
                selectConversation(newConversation.id);
                renderConversations();
            } catch (error) {
                console.error('Error creating conversation:', error);
                alert('Error creando conversación: ' + (error.response?.data?.message || error.message));
            }
        }

        // Select conversation
        async function selectConversation(conversationId) {
            currentConversationId = conversationId;
            renderConversations();

            try {
                const response = await axios.get(`http://localhost:8000/chatbot/conversations/${conversationId}`, { headers: getAuthHeaders() });
                const conversation = response.data;
                renderMessages(conversation.messages);

                // Show chat input and actions
                document.getElementById('chatbot-input-area').style.display = 'flex';
                document.getElementById('conversation-actions').style.display = 'block';
                document.getElementById('select-conversation-prompt').style.display = 'none';

                // Update header
                document.getElementById('chatbot-header').querySelector('h2').textContent = conversation.title;
            } catch (error) {
                console.error('Error loading conversation:', error);
                alert('Error cargando conversación: ' + (error.response?.data?.message || error.message));
            }
        }

        // Render messages
        function renderMessages(messages) {
            const messagesDiv = document.getElementById('chatbot-messages');
            messagesDiv.innerHTML = '';

            if (!messages || messages.length === 0) {
                messagesDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay mensajes en esta conversación.<br>¡Envía el primero!</p>';
                return;
            }

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.style.cssText = `
                    margin-bottom: 10px;
                    padding: 10px;
                    border-radius: 8px;
                    max-width: 70%;
                    ${message.role === 'user' ? 'margin-left: auto; background: #007bff; color: white;' : 'margin-right: auto; background: #f1f1f1; color: #333;'}
                `;

                let messageContent = message.content;

                // Add links if present
                if (message.links && message.links.length > 0) {
                    messageContent += '<br><br><strong>Enlaces útiles:</strong><br>';
                    message.links.forEach(link => {
                        messageContent += `<a href="${link}" target="_blank" style="color: ${message.role === 'user' ? '#cce5ff' : '#007bff'}; text-decoration: underline;">${link}</a><br>`;
                    });
                }

                messageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${message.role === 'user' ? 'Tú' : 'Chatbot Educativo'}</div>
                    <div>${messageContent}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">${new Date(message.timestamp).toLocaleString()}</div>
                `;

                messagesDiv.appendChild(messageDiv);
            });

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send chatbot message
        async function sendChatbotMessage() {
            const messageInput = document.getElementById('chatbot-message');
            const message = messageInput.value.trim();

            if (!message) return;

            // If no conversation is selected, create a new one automatically
            if (!currentConversationId) {
                await createNewConversation();
            }

            // Clear input
            messageInput.value = '';

            // Add user message to UI immediately
            const messagesDiv = document.getElementById('chatbot-messages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message';
            userMessageDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 70%; margin-left: auto; background: #007bff; color: white;';
            userMessageDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">Tú</div>
                <div>${message}</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">${new Date().toLocaleString()}</div>
            `;
            messagesDiv.appendChild(userMessageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await axios.post(`http://localhost:8000/chatbot/conversations/${currentConversationId}/messages`,
                    { message },
                    { headers: getAuthHeaders() }
                );

                const botResponse = response.data;

                // Add bot response to UI
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message';
                botMessageDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 70%; margin-right: auto; background: #f1f1f1; color: #333;';

                let botMessageContent = botResponse.assistantMessage.content;

                // Add links if present
                if (botResponse.assistantMessage.links && botResponse.assistantMessage.links.length > 0) {
                    botMessageContent += '<br><br><strong>Enlaces útiles:</strong><br>';
                    botResponse.assistantMessage.links.forEach(link => {
                        botMessageContent += `<a href="${link}" target="_blank" style="color: #007bff; text-decoration: underline;">${link}</a><br>`;
                    });
                }

                botMessageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Chatbot Educativo</div>
                    <div>${botMessageContent}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">${new Date().toLocaleString()}</div>
                `;

                messagesDiv.appendChild(botMessageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                // Update conversation in list
                await loadConversations();

            } catch (error) {
                console.error('Error sending message:', error);

                // Show error message
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'message';
                errorMessageDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 70%; margin-right: auto; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
                errorMessageDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Error</div>
                    <div>Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.</div>
                `;
                messagesDiv.appendChild(errorMessageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                if (error.response && error.response.status === 401) {
                    alert('Token expirado. Por favor, inicia sesión de nuevo.');
                    logout();
                }
            }
        }

        // Delete conversation
        async function deleteConversation() {
            if (!currentConversationId) return;

            if (!confirm('¿Eliminar esta conversación? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                await axios.delete(`http://localhost:8000/api/chatbot/conversations/${currentConversationId}`, { headers: getAuthHeaders() });
                
                // Remove from local array
                chatbotConversations = chatbotConversations.filter(conv => conv.id !== currentConversationId);
                
                // Clear current conversation
                currentConversationId = null;
                document.getElementById('chatbot-messages').innerHTML = '';
                document.getElementById('chatbot-input-area').style.display = 'none';
                document.getElementById('conversation-actions').style.display = 'none';
                document.getElementById('select-conversation-prompt').style.display = 'block';
                document.getElementById('chatbot-header').querySelector('h2').textContent = 'Chatbot Educativo';
                
                renderConversations();
                
                alert('Conversación eliminada exitosamente');
            } catch (error) {
                console.error('Error deleting conversation:', error);
                alert('Error eliminando conversación: ' + (error.response?.data?.message || error.message));
            }
        }

        // Event listeners for chatbot
        document.getElementById('new-conversation-btn').addEventListener('click', createNewConversation);
        document.getElementById('send-chatbot').addEventListener('click', sendChatbotMessage);
        document.getElementById('delete-conversation-btn').addEventListener('click', deleteConversation);

        // Enter key for chatbot message input
        document.getElementById('chatbot-message').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatbotMessage();
            }
        });

        // Navigation to chatbot view
        document.getElementById('show-chatbot').addEventListener('click', async () => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('chatbot-view').style.display = 'block';
            await loadConversations();
            // Show input area immediately for direct chatting
            document.getElementById('chatbot-input-area').style.display = 'flex';
            document.getElementById('select-conversation-prompt').style.display = 'none';
            // If no conversations exist, create a new one automatically
            if (chatbotConversations.length === 0) {
                await createNewConversation();
            } else {
                // Select the most recent conversation
                selectConversation(chatbotConversations[0].id);
            }
        });

        function openSubmissionModal(type, id) {
            currentSubmissionType = type;
            currentSubmissionId = id;
            selectedFiles = [];

            // Reset form
            document.getElementById('submission-content').value = '';
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('submission-status').style.display = 'none';

            // Show modal
            document.getElementById('submission-modal').style.display = 'flex';

            // Set up drag and drop
            setupFileDropArea();
        }

        function closeSubmissionModal() {
            document.getElementById('submission-modal').style.display = 'none';
            currentSubmissionType = null;
            currentSubmissionId = null;
            selectedFiles = [];
        }

        function setupFileDropArea() {
            const dropArea = document.getElementById('file-drop-area');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropArea.classList.add('dragover');
            }

            function unhighlight(e) {
                dropArea.classList.remove('dragover');
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            [...files].forEach(file => {
                if (selectedFiles.length >= 10) {
                    alert('Máximo 10 archivos permitidos');
                    return;
                }
                selectedFiles.push(file);
                displayFile(file);
            });
        }

        function displayFile(file) {
            const fileList = document.getElementById('file-list');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                <button type="button" class="remove-file" onclick="removeFile('${file.name}')">×</button>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            selectedFiles.forEach(displayFile);
        }

        // Handle file input change
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = e.target.files;
            handleFiles(files);
        });

        // Submit submission
        async function submitSubmission() {
            if (!currentSubmissionId || !currentSubmissionType) {
                alert('Error: No hay tarea seleccionada');
                return;
            }

            const content = document.getElementById('submission-content').value;
            const statusDiv = document.getElementById('submission-status');

            if (selectedFiles.length === 0) {
                alert('Selecciona al menos un archivo');
                return;
            }

            try {
                statusDiv.className = 'submission-status pending';
                statusDiv.textContent = 'Enviando entrega...';
                statusDiv.style.display = 'block';

                const formData = new FormData();
                formData.append('taskId', currentSubmissionId.toString());
                if (content) {
                    formData.append('content', content);
                }

                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                const response = await axios.post('http://localhost:8000/submissions', formData, {
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'multipart/form-data'
                    }
                });

                statusDiv.className = 'submission-status submitted';
                statusDiv.textContent = 'Entrega realizada exitosamente';

                // Close modal after success
                setTimeout(() => {
                    closeSubmissionModal();
                    // Refresh tasks to show updated status
                    refreshData();
                }, 2000);

            } catch (error) {
                console.error('Error submitting:', error);
                statusDiv.className = 'submission-status rejected';
                statusDiv.textContent = 'Error: ' + (error.response?.data?.message || error.message);
            }
        }
    </script>
</body>
</html>
